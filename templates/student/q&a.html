<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audio Recorder with Enhanced Wave and Add URL to Textarea</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/>
</head>
<body>
  <div class="container mt-4">
    <div class="card shadow">
      <div class="card-header bg-purple text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Ask a New Question</h5>
        <button type="button" class="close text-white">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="card-body">
        <form>
          <div class="form-row">
            <div class="form-group col-md-4">
              <select class="form-control">
                <option selected>HSC Q&A Service</option>
              </select>
            </div>
            <div class="form-group col-md-4">
              <select class="form-control">
                <option selected>Select Subject</option>
              </select>
            </div>
            <div class="form-group col-md-4">
              <select class="form-control">
                <option selected>Select Chapter</option>
              </select>
            </div>
          </div>

          <!-- New Container Above the Textarea -->
          <div id="container-above-textarea" class="mb-3 p-3" style="background-color: #f5f5f5; border-radius: 8px; border: 1px solid #ccc;">
            <h5>Uploaded File:</h5>
            <div class="uploaded-file">
              <img src="file-icon.png" alt="Uploaded file" style="width: 50px; height: 50px;" />
              <p>File name or information about the uploaded file...</p>
            </div>
          </div>

          <!-- Textarea -->
          <div class="form-group">
            <textarea class="form-control" rows="4" id="question-textarea" placeholder="Ask a question"></textarea>
          </div>
          
          <div class="form-group d-flex justify-content-end">
            <input type="file" id="file-input" style="display: none;" accept="image/*">
            <button type="button" class="btn btn-purple mx-1"><i class="fas fa-paperclip"></i></button>
            <button type="button" class="btn btn-teal mx-1" id="camera-button"><i class="fas fa-camera"></i></button>
            <button type="button" class="btn btn-green mx-1" id="mic-button"><i class="fas fa-microphone"></i></button>
            <button type="submit" class="btn btn-lightblue">Submit</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <style>
    /* Modal and form styling */
    .bg-purple {
      background-color: #5e3260;
    }
    .text-white {
      color: #ffffff;
    }
    .btn-purple {
      background-color: #754192;
      color: #ffffff;
      border-radius: 50%;
    }
    .btn-teal {
      background-color: #418b7a;
      color: #ffffff;
      border-radius: 50%;
    }
    .btn-green {
      background-color: #4CAF50;
      color: #ffffff;
      border-radius: 50%;
    }
    .btn-lightblue {
      background-color: #a5bfff;
      color: #ffffff;
    }
    .card {
      border-radius: 10px;
    }
    .card-header .close {
      font-size: 24px;
      font-weight: bold;
      line-height: 1;
      opacity: 1;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1050;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 15px;
      width: 350px;
      height: 400px;
      text-align: center;
      position: relative;
      box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.2);
    }
    .mic-icon-container {
      background-color: #4CAF50;
      color: white;
      font-size: 40px;
      border-radius: 50%;
      padding: 15px;
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .timer {
      font-size: 24px;
      margin-bottom: 20px;
      color: #333;
      font-weight: bold;
    }
    .start-btn, .stop-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    .stop-btn {
      background-color: #f44336; /* Red Stop Button */
      color: white;
    }
    .close-modal {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 20px;
      color: #aaa;
      cursor: pointer;
    }
    .close-modal:hover,
    .close-modal:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    /* Waveform container and styling */
    #waveform-container {
      width: 100%;
      height: 100px;
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 8px;
      overflow: hidden;
    }

    canvas {
      border-radius: 8px;
    }

    /* Hidden view */
    .d-none {
      display: none;
    }
  </style>

  <script>
    document.getElementById('camera-button').addEventListener('click', function() {
      document.getElementById('file-input').click();
    });

    document.addEventListener('DOMContentLoaded', function() {
      let mediaRecorder;
      let audioChunks = [];
      let audioBlobUrl;
      let audioContext;
      let source;
      let analyser;
      let canvas = document.getElementById('waveform');
      let canvasCtx = canvas.getContext('2d');
      let timerInterval;
      let startTime;
      let isRecording = false;

      const startButton = document.getElementById('start-btn');
      const timerElement = document.getElementById('timer');
      const modal = document.getElementById('micModal');
      const micButton = document.getElementById('mic-button');
      const closeModal = document.querySelector('.close-modal');
      const recordingView = document.getElementById('recording-view');
      const finishedView = document.getElementById('finished-view');
      const audioPlayer = document.getElementById('audio-player');
      const audioSource = document.getElementById('audio-source');
      const deleteBtn = document.getElementById('delete-btn');
      const addBtn = document.getElementById('add-btn');
      const textarea = document.getElementById('question-textarea');

      // Show the modal when the mic button is clicked
      micButton.addEventListener('click', function() {
        modal.style.display = 'block';
        resetToInitialView();
      });

      // Close the modal when the close button is clicked
      closeModal.addEventListener('click', function() {
        modal.style.display = 'none';
        resetRecording();
      });

      // Close the modal if the user clicks outside the modal content
      window.addEventListener('click', function(event) {
        if (event.target === modal) {
          modal.style.display = 'none';
          resetRecording();
        }
      });

      startButton.addEventListener('click', async function() {
        if (!isRecording) {
          // Start Recording
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.start();

          // Set up Audio Context for waveform visualization
          audioContext = new AudioContext();
          source = audioContext.createMediaStreamSource(stream);
          analyser = audioContext.createAnalyser();
          analyser.fftSize = 1024; // Increased fftSize for smoother wave
          source.connect(analyser);

          mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
          };

          mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            audioBlobUrl = URL.createObjectURL(audioBlob);
            audioSource.src = audioBlobUrl;
            audioPlayer.load();
          };

          // Start Timer
          startTime = Date.now();
          timerInterval = setInterval(updateTimer, 1000);

          // Replace Start button with Stop button
          startButton.textContent = "Stop";
          startButton.classList.remove("btn-green");
          startButton.classList.add("stop-btn");

          // Start drawing the waveform
          isRecording = true;
          drawWaveform();
        } else {
          // Stop Recording and show the finished view
          stopRecording();
          replaceWithFinishedView();
        }
      });

      function updateTimer() {
        const elapsedTime = Date.now() - startTime;
        const seconds = Math.floor(elapsedTime / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);

        const displaySeconds = String(seconds % 60).padStart(2, '0');
        const displayMinutes = String(minutes % 60).padStart(2, '0');
        const displayHours = String(hours).padStart(2, '0');

        timerElement.textContent = `${displayHours}:${displayMinutes}:${displaySeconds}`;
      }

      function drawWaveform() {
        if (!isRecording) return;

        requestAnimationFrame(drawWaveform);

        let bufferLength = analyser.fftSize;
        let dataArray = new Uint8Array(bufferLength);
        analyser.getByteTimeDomainData(dataArray);

        canvasCtx.clearRect(0, 0, canvas.width, canvas.height);

        // Green color wave effect with smoother curves
        canvasCtx.strokeStyle = '#4CAF50'; // Green color for the wave

        canvasCtx.lineWidth = 2;
        canvasCtx.shadowBlur = 5;
        canvasCtx.shadowColor = "rgba(76, 175, 80, 0.6)"; // Soft green shadow

        canvasCtx.beginPath();

        let sliceWidth = canvas.width / bufferLength;
        let x = 0;

        for (let i = 0; i < bufferLength; i++) {
          let v = dataArray[i] / 128.0;
          let y = v * canvas.height / 2;

          if (i === 0) {
            canvasCtx.moveTo(x, y);
          } else {
            canvasCtx.quadraticCurveTo(x - sliceWidth / 2, y, x, y); // Smoother curves
          }

          x += sliceWidth;
        }

        canvasCtx.stroke();
      }

      function stopRecording() {
        clearInterval(timerInterval);
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
          mediaRecorder.stop();
        }
        if (audioContext) {
          audioContext.close();
        }
        isRecording = false;
      }

      function resetRecording() {
        recordingView.classList.remove('d-none');
        finishedView.classList.add('d-none');
        startButton.textContent = "Start";
        startButton.classList.remove("stop-btn");
        startButton.classList.add("btn-green");
        timerElement.textContent = "00:00:00";
        document.getElementById('waveform-container').style.display = 'block';
        startButton.style.display = 'inline-block';
        drawStartLine(); // Reset to start line
      }

      function replaceWithFinishedView() {
        // Hide the waveform and stop button
        document.getElementById('waveform-container').style.display = 'none';
        startButton.style.display = 'none';

        // Show audio player and delete/add buttons
        finishedView.classList.remove('d-none');
      }

      function drawStartLine() {
        canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
        canvasCtx.strokeStyle = 'rgb(200, 200, 200)';
        canvasCtx.lineWidth = 2;
        canvasCtx.beginPath();
        canvasCtx.moveTo(0, canvas.height / 2);
        canvasCtx.lineTo(canvas.width, canvas.height / 2);
        canvasCtx.stroke();
      }

      function resetToInitialView() {
        resetRecording();
        audioChunks = [];
      }

      // Delete action
      deleteBtn.addEventListener('click', function() {
        resetToInitialView();
      });

      // Add action
      addBtn.addEventListener('click', function() {
        if (audioBlobUrl) {
          textarea.value += `\nRecorded Audio: ${audioBlobUrl}`;
        }
        modal.style.display = 'none';
        resetRecording();
      });
    });
  </script>

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
